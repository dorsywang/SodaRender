/**
 * SodaRender
 * light Tml render engine
 * copyright @ Tencent AlloyTeam
 * License under MIT License
 * @author dorsywang
 * @email 314416946@qq.com
 * @blog http://www.dorsywang.com
 * @TeamBlog http://www.alloyteam.com
 */
(function(){var e=/\{\{([^\}]*)\}\}/g,t=function(e){return new RegExp("(^|\\s+)"+e+"(\\s+|$)","g")},n=function(e,n){if(!e.className){e.className=n;return}e.className.match(t(n))||(e.className+=" "+n)},r=function(e,n){e.className=e.className.replace(t(n),"")},i=function(e,t){y.lastIndex=0;var n=t.replace(y,function(t){return typeof e[t]=="undefined"?t:e[t]});if(t==="true")return!0;if(t==="false")return!1;var r=function(t,i){var s=i.indexOf(".");if(s>-1){var o=i.substr(0,s);i=i.substr(s+1),typeof e[o]!="undefined"&&g.test(o)&&(o=e[o]);if(typeof t[o]!="undefined")return r(t[o],i);var u={name:n,data:e};return O("nullvalue",{type:"nullattr",data:u},u),""}typeof e[i]!="undefined"&&g.test(i)&&(i=e[i]);var a;if(typeof t[i]!="undefined")a=t[i];else{var u={name:n,data:e};O("nullvalue",{type:"nullvalue",data:u},u),a=""}return a};return r(e,t)},s=function(e){},o=/[a-zA-Z_\$]+[\w\$]*/g,u=/"([^"]*)"|'([^']*)'/g,a=/\d+|\d*\.\d+/g,f=/[a-zA-Z_\$]+[\w\$]*(?:\s*\.\s*(?:[a-zA-Z_\$]+[\w\$]*|\d+))*/g,l=/\[([^\[\]]*)\]/g,c=/\.([a-zA-Z_\$]+[\w\$]*)/g,h=/[^\.|]([a-zA-Z_\$]+[\w\$]*)/g,p=/\|\|/g,d="OR_OPERATOR",v=function(){return"$$"+~~(Math.random()*1e6)},m="_$C$_",g=/^_\$C\$_/,y=/_\$C\$_[^\.]+/g,b=function(){return m+~~(Math.random()*1e6)},w=function(e,t){e=e.replace(p,d).split("|");for(var n=0;n<e.length;n++)e[n]=(e[n].replace(new RegExp(d,"g"),"||")||"").trim();var r=e[0]||"",s=e.slice(1);r=r.replace(u,function(e,n,r){var i=v();return t[i]=n||r,i});while(l.test(r))l.lastIndex=0,r=r.replace(l,function(e,n){var r=b(),i=w(n,t);return t[r]=i,"."+r});r=r.replace(f,function(e){return"getValue(scope,'"+e.trim()+"')"});var o=function(){var e=s.shift();if(!e)return;var e=e.split(":"),t=e.slice(1)||[],n=e[0]||"",i=/^'.*'$|^".*"$/;for(var u=0;u<t.length;u++)f.test(t[u])&&(t[u]="getValue(scope,'"+t[u]+"')");T[n]&&(t.unshift(r),t=t.join(","),r="sodaFilterMap['"+n+"']("+t+")"),o()};o();var a=(new Function("getValue","sodaFilterMap","return function sodaExp(scope){ return "+r+"}"))(i,T);return a(t)},E={id2Expression:{},expression2id:{},getRandId:function(){return"soda"+~~(Math.random()*1e5)}},S=function(t,n){t.nodeType===3&&(t.nodeValue=t.nodeValue.replace(e,function(e,t){return w(t,n)})),t.attributes&&(N.map(function(e){var r=e.name,i=e.opt;t.getAttribute(r)&&t.parentNode&&i.link(n,t,t.attributes)}),[].map.call(t.attributes,function(r){if(!x[r.name])if(/^soda-/.test(r.name)){var i=r.name.replace(/^soda-/,"");if(i){var s=r.value.replace(e,function(e,t){return w(t,n)});t.setAttribute(i,s)}}else r.value=r.value.replace(e,function(e,t){return w(t,n)})})),[].map.call([].slice.call(t.childNodes,[]),function(e){S(e,n)})},x={},T={},N=[],C=function(e,t){var e="soda-"+e;x[e]=t(),N.push({name:e,opt:x[e]})},k=function(e,t){T[e]=t};k.get=function(e){return T[e]},k("date",function(e,t){return t}),C("repeat",function(){return{priority:10,compile:function(e,t,n){},link:function(e,t,n){var r=t.getAttribute("soda-repeat"),s,o,u=/\s+track\s+by\s+([^\s]+)$/,a;r=r.replace(u,function(e,t){return t&&(a=(t||"").trim()),""});var f=/([^\s]+)\s+in\s+([^\s]+)|\(([^,]+)\s*,\s*([^)]+)\)\s+in\s+([^\s]+)/,l=f.exec(r);if(!l)return;if(l[1]&&l[2]){s=(l[1]||"").trim(),o=(l[2]||"").trim();if(!s||!o)return}else l[3]&&l[4]&&l[5]&&(a=(l[3]||"").trim(),s=(l[4]||"").trim(),o=(l[5]||"").trim());a=a||"$index";var c=i(e,o)||[],h=function(n){var r=t.cloneNode(!0),i={};i[a]=n,i[s]=c[n],i.__proto__=e,r.removeAttribute("soda-repeat"),t.parentNode.insertBefore(r,t),S(r,i)};if("length"in c)for(var p=0;p<c.length;p++)h(p);else for(var p in c)c.hasOwnProperty(p)&&h(p);t.parentNode.removeChild(t)}}}),C("if",function(){return{priority:9,link:function(e,t,n){var r=t.getAttribute("soda-if"),i=w(r,e);i||t.parentNode&&t.parentNode.removeChild(t)}}}),C("class",function(){return{link:function(e,t,r){var i=t.getAttribute("soda-class"),s=w(i,e);s&&n(t,s)}}}),C("src",function(){return{link:function(t,n,r){var i=n.getAttribute("soda-src"),s=i.replace(e,function(e,n){return w(n,t)});s&&n.setAttribute("src",s)}}}),C("bind-html",function(){return{link:function(e,t,n){var r=t.getAttribute("soda-bind-html"),i=w(r,e);if(i)return t.innerHTML=i,{command:"childDone"}}}}),C("style",function(){return{link:function(e,t,n){var r=t.getAttribute("soda-style"),i=w(r,e),s=function(e,t){var n=/opacity|z-index/;return n.test(e)?parseFloat(t):isNaN(t)?t:t+"px"};if(i){var o=[];for(var u in i)if(i.hasOwnProperty(u)){var a=s(u,i[u]);o.push([u,a].join(":"))}var f=t.style;for(var u=0;u<f.length;u++){var l=f[u];i[l]||o.push([l,f[l]].join(":"))}var c=o.join(";");t.setAttribute("style",c)}}}});var L=function(e,t){N.sort(function(e,t){return Number(t.opt.priority||0)-Number(e.opt.priority||0)}),console.log(N);var n=document.createElement("div");n.innerHTML=e,[].map.call([].slice.call(n.childNodes,[]),function(e){S(e,t)});var r=document.createDocumentFragment();r.innerHTML=n.innerHTML,r.update=function(e){var n=DeepDiff.noConflict(),r=n(t,e);console.log(r);var i=["a"];for(var s=0;s<i.length;s++){var o=i[s],u=E.expression2id[o],a=w(o,e);u.el&&(u.el.nodeValue=a)}console.log(E)};var i;while(i=n.childNodes[0])r.appendChild(i);return r},A={};L.addEventListener=function(e,t){A[e]||(A[e]=[]),A[e].push(t)},L.author="dorsy";var O=function(e,t,n){var r=A[e]||[];for(var i=0;i<r.length;i++){var s=r[i];s&&s(t,n)}},M=function(e,t){};if(!window.sodaRender||window.sodaRender.author!=="dorsy")window.sodaRender=L,window.sodaFilter=k})()
